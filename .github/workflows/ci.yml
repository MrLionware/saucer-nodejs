name: Build & Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DEBUG: 'napi:*'

jobs:
  # ===========================================================================
  # Build native binaries for all platforms
  # ===========================================================================
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM64 (Apple Silicon)
          # Use macos-15 (newer AppleClang/Xcode) because saucer v8 pulls
          # nontype_functional, which fails to compile on AppleClang 15.x.
          - os: macos-15
            target: darwin-arm64
            arch: arm64
            platform: darwin
            
          # macOS x64 (Intel) - using macos-15 with Rosetta
          - os: macos-15
            target: darwin-x64
            arch: x64
            platform: darwin
            
          # TODO: Windows and Linux builds require additional setup
          # Windows needs WebView2 SDK with CMake config files
          # Linux needs WebKitGTK 4.1 and GCC 14
          # For now, prebuilds for these platforms should be done locally
          
          # # Windows x64
          # - os: windows-latest
          #   target: win32-x64
          #   arch: x64
          #   platform: win32
          #   
          # # Windows ARM64
          # - os: windows-latest
          #   target: win32-arm64
          #   arch: arm64
          #   platform: win32
          #   
          # # Linux x64 (Ubuntu)
          # - os: ubuntu-24.04
          #   target: linux-x64-gnu
          #   arch: x64
          #   platform: linux
          #   
          # # Linux ARM64 (using QEMU)
          # - os: ubuntu-24.04
          #   target: linux-arm64-gnu
          #   arch: arm64
          #   platform: linux
          #   docker: true

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------------------------------------------------------
      # macOS Setup
      # -------------------------------------------------------------------------
      - name: Install dependencies (macOS)
        if: matrix.platform == 'darwin'
        run: |
          brew install cmake ninja
          echo "Using Xcode $(xcodebuild -version | head -1)"

      # -------------------------------------------------------------------------
      # Windows Setup
      # -------------------------------------------------------------------------
      - name: Setup MSVC (Windows)
        if: matrix.platform == 'win32'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Install dependencies (Windows)
        if: matrix.platform == 'win32'
        shell: pwsh
        run: |
          choco install cmake ninja -y
          
          # Use runner's vcpkg to install webview2
          $vcpkg = "$env:VCPKG_INSTALLATION_ROOT\vcpkg.exe"
          if (Test-Path $vcpkg) {
            & $vcpkg install webview2:${{ matrix.arch }}-windows-static
            echo "CMAKE_PREFIX_PATH=$env:VCPKG_INSTALLATION_ROOT\installed\${{ matrix.arch }}-windows-static\share" >> $env:GITHUB_ENV
            echo "VCPKG_INSTALLED=$env:VCPKG_INSTALLATION_ROOT\installed\${{ matrix.arch }}-windows-static" >> $env:GITHUB_ENV
          } else {
            # Fallback: clone and bootstrap vcpkg
            git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
            C:\vcpkg\vcpkg.exe install webview2:${{ matrix.arch }}-windows-static
            echo "CMAKE_PREFIX_PATH=C:\vcpkg\installed\${{ matrix.arch }}-windows-static\share" >> $env:GITHUB_ENV
          }

      # -------------------------------------------------------------------------
      # Linux Setup
      # -------------------------------------------------------------------------
      - name: Install dependencies (Linux x64)
        if: matrix.platform == 'linux' && matrix.arch == 'x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential
          # Install GCC 14 for C++23 support
          sudo apt-get install -y gcc-14 g++-14
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
          # Ubuntu 24.04 uses libwebkit2gtk-4.1-dev  
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev
          gcc --version
          cmake --version

      - name: Setup QEMU (Linux ARM64)
        if: matrix.docker == true
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # -------------------------------------------------------------------------
      # Build
      # -------------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm install --ignore-scripts

      - name: Build (Linux ARM64 Docker)
        if: matrix.docker == true
        uses: addnab/docker-run-action@v3
        with:
          image: node:20-bookworm
          options: -v ${{ github.workspace }}:/work -w /work --platform linux/arm64
          run: |
            apt-get update
            apt-get install -y cmake ninja-build build-essential
            # Debian Bookworm uses libwebkit2gtk-4.1-dev
            apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev
            npm install --ignore-scripts
            npm run rebuild
            cp -r build/Release/* npm/linux-arm64-gnu/

      - name: Build (native - non-Windows)
        if: matrix.docker != true && matrix.platform != 'win32'
        run: npx cmake-js rebuild --CDsaucer_no_compiler_version_check=ON
        env:
          npm_config_build_from_source: true

      - name: Build (Windows)
        if: matrix.platform == 'win32'
        shell: pwsh
        run: |
          # Build with saucer_no_compiler_version_check to allow current MSVC
          npx cmake-js rebuild --CDsaucer_no_compiler_version_check=ON
        env:
          npm_config_build_from_source: true

      # -------------------------------------------------------------------------
      # Copy build artifacts to npm package directory
      # -------------------------------------------------------------------------
      - name: Copy artifacts (macOS)
        if: matrix.platform == 'darwin'
        run: |
          mkdir -p npm/${{ matrix.target }}
          cp build/Release/saucer-nodejs.node npm/${{ matrix.target }}/
          cp build/Release/*.dylib npm/${{ matrix.target }}/ 2>/dev/null || true

          # Rewrite dylib lookup to artifact-local paths so prebuilt testing does
          # not depend on the original build/Release directory.
          libs=(
            "libsaucer-bindings-desktop.dylib"
            "libsaucer-bindings-pdf.dylib"
            "libsaucer-bindings-loop.dylib"
            "libsaucer-bindings.dylib"
            "libsaucer.dylib"
          )

          for bin in "saucer-nodejs.node" "${libs[@]}"; do
            file="npm/${{ matrix.target }}/${bin}"
            [ -f "$file" ] || continue

            for dep in "${libs[@]}"; do
              install_name_tool -change "@rpath/${dep}" "@loader_path/${dep}" "$file" 2>/dev/null || true
            done

            install_name_tool -delete_rpath "$(pwd)/build/Release" "$file" 2>/dev/null || true
            install_name_tool -add_rpath "@loader_path" "$file" 2>/dev/null || true
          done

          otool -L npm/${{ matrix.target }}/saucer-nodejs.node || true
          otool -l npm/${{ matrix.target }}/saucer-nodejs.node | grep -A2 LC_RPATH || true
          ls -la npm/${{ matrix.target }}/

      - name: Copy artifacts (Windows)
        if: matrix.platform == 'win32'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path npm/${{ matrix.target }}
          Copy-Item build/Release/saucer-nodejs.node npm/${{ matrix.target }}/
          Copy-Item build/Release/*.dll npm/${{ matrix.target }}/ -ErrorAction SilentlyContinue
          Get-ChildItem npm/${{ matrix.target }}/

      - name: Copy artifacts (Linux x64)
        if: matrix.platform == 'linux' && matrix.arch == 'x64'
        run: |
          mkdir -p npm/${{ matrix.target }}
          cp build/Release/saucer-nodejs.node npm/${{ matrix.target }}/
          cp build/Release/*.so* npm/${{ matrix.target }}/ 2>/dev/null || true
          ls -la npm/${{ matrix.target }}/

      # -------------------------------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------------------------------
      - name: Upload platform package
        uses: actions/upload-artifact@v4
        with:
          name: npm-${{ matrix.target }}
          path: npm/${{ matrix.target }}/
          retention-days: 7
          if-no-files-found: error

  # ===========================================================================
  # Test the builds
  # ===========================================================================
  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            target: darwin-arm64
          - os: macos-15
            target: darwin-x64
          # # Windows/Linux tests disabled until builds are fixed
          # - os: windows-latest
          #   target: win32-x64
          # - os: ubuntu-24.04
          #   target: linux-x64-gnu

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download platform package
        uses: actions/download-artifact@v4
        with:
          name: npm-${{ matrix.target }}
          path: npm/${{ matrix.target }}/

      - name: Install dependencies
        run: npm install --ignore-scripts

      - name: List downloaded files
        run: ls -laR npm/${{ matrix.target }}/
        shell: bash

      - name: Create test script
        shell: bash
        run: |
          cat << 'EOF' > test-prebuilt.js
          import { createRequire } from 'module';
          import { join, dirname } from 'path';
          import { fileURLToPath } from 'url';
          
          const require = createRequire(import.meta.url);
          const __dirname = dirname(fileURLToPath(import.meta.url));
          
          // Test loading the native module
          const binding = require(join(__dirname, 'npm', '${{ matrix.target }}', 'saucer-nodejs.node'));
          console.log('✅ Native binding loaded successfully!');
          console.log('   Exports:', Object.keys(binding));
          
          // Test creating an application
          const app = new binding.Application({});
          console.log('✅ Application created successfully!');
          console.log('   Thread safe:', app.isThreadSafe());
          
          // Clean up and exit
          console.log('✅ All tests passed!');
          process.exit(0);
          EOF

      - name: Run test
        run: node test-prebuilt.js
        env:
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/npm/${{ matrix.target }}
        timeout-minutes: 2

  # ===========================================================================
  # Publish to npm (on tag push)
  # ===========================================================================
  publish:
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://registry.npmjs.org'

      - name: Download all platform packages
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: npm-*

      - name: Prepare platform packages
        run: |
          for dir in artifacts/npm-*/; do
            target=$(basename "$dir" | sed 's/npm-//')
            echo "Processing $target..."
            mkdir -p npm/$target
            cp -r "$dir"/* npm/$target/
            ls -la npm/$target/
          done

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in all packages
        run: |
          # Update main package version
          npm version ${{ steps.version.outputs.VERSION }} --no-git-tag-version
          
          # Update platform package versions
          for pkg in npm/*/package.json; do
            echo "Updating $pkg..."
            node -e "
              const fs = require('fs');
              const pkg = JSON.parse(fs.readFileSync('$pkg'));
              pkg.version = '${{ steps.version.outputs.VERSION }}';
              fs.writeFileSync('$pkg', JSON.stringify(pkg, null, 2) + '\n');
            "
          done

      - name: Publish platform packages
        run: |
          for dir in npm/*/; do
            echo "Publishing $(basename $dir)..."
            cd "$dir"
            npm publish --access public --provenance || echo "Failed to publish $(basename $dir)"
            cd ../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Install dependencies for main package
        run: npm install --ignore-scripts

      - name: Publish main package
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            npm/*/saucer-nodejs.node
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
